<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد الطهي الذكي - ابحث عن وصفات بمكوناتك</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif; /* Prefer Cairo for Arabic */
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
            transition: background-color 0.3s ease; /* Smooth transition for dark/light mode */
        }
        .dark-mode {
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .light-mode {
            background-color: #f0f2f5;
            color: #333;
        }
        .light-mode .bg-gray-800 { background-color: #ffffff; }
        .light-mode .bg-gray-700 { background-color: #e0e2e5; }
        .light-mode .bg-gray-900 { background-color: #f7f7f7; }
        .light-mode .text-gray-400, .light-mode .text-gray-300 { color: #555; }
        .light-mode .border-gray-600 { border-color: #ccc; }
        .light-mode .text-white { color: #333; }
        .light-mode .text-blue-400 { color: #2563eb; }
        .light-mode .bg-blue-500 { background-color: #3b82f6; }
        .light-mode .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .light-mode .bg-green-600 { background-color: #10b981; }
        .light-mode .hover\:bg-green-700:hover { background-color: #059669; }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2d3748; /* bg-gray-700 equivalent */
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
            color: #c9d1d9;
        }
        .autocomplete-items div:hover {
            background-color: #3b4d66; /* Slightly lighter gray */
        }
        .autocomplete-active {
            background-color: #3b4d66 !important;
            color: #c9d1d9;
        }
        .loading-animation {
            width: 50px;
            height: 50px;
            border: 5px solid #2563eb; /* Blue border */
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1K67XY75YJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1K67XY75YJ');
    </script>

</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 dark-mode">

    <button id="themeToggle" class="absolute top-4 right-4 p-2 rounded-full bg-gray-700 text-white shadow-md hover:bg-gray-600 transition-colors duration-200">
        <i class="fas fa-sun" id="themeIcon"></i>
    </button>

    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-auto transform transition-all duration-300 hover:scale-[1.01]">
        <h1 class="text-4xl font-bold text-center mb-6 text-white border-b-2 border-blue-500 pb-3">
            مساعد الطهي الذكي
        </h1>
        <p class="text-gray-400 text-center mb-6">
            أدخل المكونات المتوفرة لديك وسأقترح عليك وصفات شهية!
        </p>

        <div class="mb-6 bg-gray-700 p-4 rounded-lg shadow-inner relative"> <label for="ingredientInput" class="block text-sm font-medium text-gray-300 mb-2">
                أدخل المكونات (مثال: دجاج، أرز، بصل، طماطم):
            </label>
            <div class="flex flex-wrap items-center gap-2 mb-3" id="ingredientsList">
                </div>
            <div class="flex gap-2">
                <input type="text" id="ingredientInput" placeholder="أدخل مكون واحد واضغط إضافة"
                        class="flex-grow p-3 bg-gray-900 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                <button id="addIngredientBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-plus ml-1"></i> إضافة
                </button>
            </div>
            <div id="autocomplete-list" class="autocomplete-items hidden"></div>
        </div>

        <button id="getRecipesBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-8 rounded-xl font-bold text-xl shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 mb-6">
            <i class="fas fa-utensils ml-2"></i> احصل على الوصفات
        </button>

        <div id="loadingIndicator" class="text-center text-blue-400 text-lg mb-6 hidden">
            <div class="loading-animation"></div>
            جاري البحث عن الوصفات...
        </div>

        <div id="recipesOutput" class="bg-gray-900 p-5 rounded-lg shadow-lg hidden">
            <h2 class="text-3xl font-bold mb-4 text-blue-400 border-b border-gray-700 pb-2">
                <i class="fas fa-clipboard-list ml-2"></i> الوصفات المقترحة:
            </h2>
            <div id="recipesContainer">
                </div>
        </div>

        <div id="errorMessage" class="bg-red-800 text-white p-4 rounded-lg shadow-md mt-6 hidden" role="alert">
            <p class="font-bold"><i class="fas fa-exclamation-triangle ml-2"></i> خطأ!</p>
            <p id="errorText"></p>
        </div>

    </div>

    <script>
        const ingredientInput = document.getElementById('ingredientInput');
        const addIngredientBtn = document.getElementById('addIngredientBtn');
        const ingredientsList = document.getElementById('ingredientsList');
        const getRecipesBtn = document.getElementById('getRecipesBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const recipesOutput = document.getElementById('recipesOutput');
        const recipesContainer = document.getElementById('recipesContainer');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const autocompleteList = document.getElementById('autocomplete-list');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const body = document.body;

        let ingredients = []; // Array to store user's ingredients
        let currentFocus; // For autocomplete keyboard navigation

        // --- Common Ingredients for Autocompletion ---
        const commonIngredients = [
            "دجاج", "لحم بقري", "لحم غنم", "سمك", "جمبري", "بيض", "حليب", "جبنة", "زبادي",
            "أرز", "خبز", "معكرونة", "بطاطس", "بصل", "ثوم", "طماطم", "فلفل", "خيار", "جزر",
            "خس", "ليمون", "برتقال", "تفاح", "موز", "زيت زيتون", "زيت نباتي", "ملح", "فلفل أسود",
            "كمون", "بابريكا", "كزبرة", "بقدونس", "نعناع", "خل", "صويا صوص", "عسل", "سكر", "دقيق",
            "عدس", "حمص", "فول", "ذرة", "فطر", "سبانخ", "بروكلي", "قرنبيط", "كوسة", "باذنجان",
            "زنجبيل", "كركم", "قرفة", "هيل", "مستردة", "مايونيز", "كاتشب", "شوكولاتة", "فانيليا", "مكسرات"
        ].sort(); // Sort alphabetically for consistent display

        // --- Theme Toggle Functionality ---
        function toggleTheme() {
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark if not set
            if (savedTheme === 'light') {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
        });

        themeToggle.addEventListener('click', toggleTheme);


        // --- Autocomplete Functionality ---
        ingredientInput.addEventListener("input", function() {
            let val = this.value;
            closeAllLists(); // Close any already open lists
            if (!val) { return false; }
            currentFocus = -1;

            let a = document.createElement("div");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);

            for (let i = 0; i < commonIngredients.length; i++) {
                // Check if item starts with the same letters as the input value
                if (commonIngredients[i].includes(val)) { // Changed from startsWith to includes for broader match
                    let b = document.createElement("div");
                    // Make the matching letters bold
                    b.innerHTML = "<strong>" + commonIngredients[i].substr(0, commonIngredients[i].indexOf(val) + val.length) + "</strong>";
                    b.innerHTML += commonIngredients[i].substr(commonIngredients[i].indexOf(val) + val.length);
                    // Insert a hidden input field that will hold the current array item's value
                    b.innerHTML += "<input type='hidden' value='" + commonIngredients[i] + "'>";
                    b.addEventListener("click", function() {
                        ingredientInput.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                        addIngredientBtn.click(); // Add ingredient immediately on selection
                    });
                    a.appendChild(b);
                }
            }
            if (a.children.length > 0) {
                autocompleteList.classList.remove('hidden');
                autocompleteList.innerHTML = a.innerHTML; // Copy children to the actual list div
            } else {
                autocompleteList.classList.add('hidden');
            }
        });

        ingredientInput.addEventListener("keydown", function(e) {
            let x = autocompleteList;
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { // DOWN key
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) { // UP key
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) { // ENTER key
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                } else {
                    addIngredientBtn.click(); // If no autocomplete selected, add current input
                }
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }

        function closeAllLists(elmnt) {
            let x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != ingredientInput) {
                    x[i].classList.add('hidden'); // Hide the autocomplete list
                }
            }
        }
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });


        // Function to display ingredients as tags
        function displayIngredients() {
            ingredientsList.innerHTML = ''; // Clear current list
            ingredients.forEach((ing, index) => {
                const tag = document.createElement('span');
                tag.className = 'inline-flex items-center bg-blue-500 text-white text-sm font-medium px-3 py-1 rounded-full ml-2 mb-2 shadow-md transition-all duration-200 transform hover:scale-105'; // ml-2 for RTL
                tag.innerHTML = `
                    ${ing}
                    <button data-index="${index}" class="mr-2 -ml-1.5 p-1 rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 remove-ingredient-btn">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `; // Reordered for RTL: text then button
                ingredientsList.appendChild(tag);
            });
        }

        // Add ingredient when button is clicked or Enter is pressed
        addIngredientBtn.addEventListener('click', () => {
            const inputVal = ingredientInput.value.trim();
            if (inputVal) {
                const newIngredients = inputVal.split(',').map(item => item.trim()).filter(item => item !== '');
                newIngredients.forEach(newIng => {
                    if (!ingredients.includes(newIng)) { // Prevent duplicates
                        ingredients.push(newIng);
                    }
                });
                ingredientInput.value = ''; // Clear input
                closeAllLists(); // Close autocomplete list after adding
                displayIngredients();
            }
        });

        ingredientInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && current
