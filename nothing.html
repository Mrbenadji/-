<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد الطهي الذكي - ابحث عن وصفات بمكوناتك</title>
    
    <!-- ... باقي الhead كما هو ... -->

</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 dark-mode">

    <!-- ... باقي الHTML كما هو ... -->

    <script>
        // ... باقي الJavaScript كما هو حتى جزء الAPI ...

        getRecipesBtn.addEventListener('click', async () => {
            hideError();
            recipesOutput.classList.add('hidden');
            recipesContainer.innerHTML = '';

            if (ingredients.length === 0) {
                showError('الرجاء إضافة مكون واحد على الأقل.');
                return;
            }

            loadingIndicator.classList.remove('hidden');

            // توجيه الطلب إلى الخادم الوسيط بدلاً من API مباشرة
            const prompt = `
                بناءً على المكونات التالية: ${ingredients.join(', ')}، اقترح 3 وصفات على الأكثر يمكن تحضيرها.
                لكل وصفة، قم بتضمين اسمها، قائمة المكونات المطلوبة (بما في ذلك المكونات التي لم يذكرها المستخدم ولكنها أساسية للوصفة)، تعليمات مفصلة خطوة بخطوة، وملاحظات إضافية إذا وجدت.
                كن إبداعيًا ومفيدًا، وتأكد من أن الوصفات واقعية وقابلة للتحضير بالمكونات الأساسية.
                يجب أن تكون جميع الردود باللغة الفصحى.
            `;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "recipeName": { "type": "STRING", "description": "اسم الوصفة" },
                                    "ingredients": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING", "description": "قائمة المكونات المطلوبة" }
                                    },
                                    "instructions": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING", "description": "خطوات التحضير مفصلة" }
                                    },
                                    "notes": { "type": "STRING", "description": "ملاحظات أو نصائح إضافية (اختياري)" }
                                },
                                required: ["recipeName", "ingredients", "instructions"]
                            }
                        }
                    }
                };

                // الحل 1: استخدام Netlify Functions
                const netlifyFunctionUrl = "https://your-site.netlify.app/.netlify/functions/gemini-proxy";
                
                // الحل 2: استخدام خدمة CORS Anywhere مؤقتاً (لتجربة فقط، ليس للإنتاج)
                // احذف المفتاح من هنا وأرسله في headers
                const apiUrl = "https://cors-anywhere.herokuapp.com/https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // لا تضع المفتاح هنا أيضاً!
                        'x-api-key': 'sk-372f2827d3e74a7badb32c07732ebc5b' // سيرسله الخادم الوسيط
                    },
                    body: JSON.stringify(payload)
                });

                // ... باقي معالجة الاستجابة كما هي ...

            } catch (error) {
                console.error('Error:', error);
                showError('حدث خطأ في الاتصال بالخادم. يرجى المحاولة لاحقاً.');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // ... باقي الJavaScript ...
    </script>
</body>
</html>